# Configuration Guide

## Overview

The Maho Module Builder now supports YAML-based configuration for deployment automation and default settings.

## Configuration File: `config.yaml`

Located at the root of the skill directory, this file controls how modules are generated and deployed.

### Deployment Settings

```yaml
deployment:
  # Target path for generated modules (relative to config.yaml or absolute)
  target_path: "../../../"  # Points to web root

  # Auto-deploy after generation
  auto_deploy: true

  # Run composer dump-autoload after deployment
  auto_composer: true

  # Flush Maho cache after deployment
  auto_flush_cache: true
```

**How it works:**
- `target_path`: Specifies where modules should be generated
  - Relative paths are resolved from the skill directory
  - If empty or not set, generates in skill's `app/` directory (old behavior)
  - Example: `"../../../"` = `/var/www/dev.tenniswarehouse.com.au/web/`

- `auto_deploy`: When `true`, modules are generated directly in the target path
  - No manual file copying needed
  - Deployment happens automatically during generation

- `auto_composer`: When `true`, runs `composer dump-autoload` after generation
  - Ensures new classes are registered in Composer's autoloader
  - Critical for module controllers to be found by Maho's router

- `auto_flush_cache`: When `true`, runs `./maho cache:flush` after generation
  - Clears Maho's cache so new module is immediately available
  - Admin users can access new module without manual cache flush

### Generator Defaults

```yaml
defaults:
  namespace: "Maho"
  code_pool: "core"
  multi_store: false
  generate_frontend: true
  generate_system_config: true
```

These provide fallback values when not specified in the module config JSON.

### Path Configuration

```yaml
paths:
  maho_cli: "./maho"
  composer: "composer"
  composer_allow_superuser: true
```

**Path resolution:**
- All commands run with `cwd` set to the deployment target path
- `maho_cli` and `composer` are relative to the web root, not the skill directory

## Module Identification

Generated modules include identification markers:

```xml
<!-- Generated by Maho Module Builder -->
<config generator="mahocommerce-builder" version="1.0">
```

**Benefits:**
1. **Force Overwrite**: The generator can safely overwrite its own modules
2. **Conflict Prevention**: Non-generated modules are protected from accidental overwrite
3. **Version Tracking**: Future versions can migrate or upgrade generated modules

**How it works:**
- Before generating, checks if module exists
- If module exists and has `generator="mahocommerce-builder"` marker:
  - Shows warning: "Module exists but was generated by this tool"
  - Proceeds with overwrite
- If module exists without marker:
  - Shows conflict error
  - Aborts generation to protect manual work

## Usage Example

```bash
# Generate module - automatically deploys to web root
python3 generate-module.py example-blog.json Maho

# Output:
✓ Using namespace from argument: Maho
✓ Full module name: Maho_TestBlog
✓ Using deployment path: /var/www/dev.tenniswarehouse.com.au/web
...
[POST-DEPLOY] Running composer dump-autoload...
  ✓ Composer autoload updated
[POST-DEPLOY] Flushing Maho cache...
  ✓ Cache flushed successfully
✅ SUCCESS - Module generated and ready to use!
```

## Workflow Benefits

**Before config.yaml:**
1. Generate module (creates in skill's app/ directory)
2. Manually copy files to web root
3. Manually run `composer dump-autoload`
4. Manually run `./maho cache:flush`
5. Test module

**After config.yaml:**
1. Generate module
2. Test module (everything else is automatic)

## Disabling Auto-Deployment

To revert to the old behavior (generate in skill directory):

```yaml
deployment:
  target_path: ""  # Empty = use skill's app/ directory
  auto_deploy: false
  auto_composer: false
  auto_flush_cache: false
```

Or simply delete/rename `config.yaml` - the generator will fall back to the old behavior.

## Troubleshooting

### Composer Warning

If you see:
```
⚠ Composer warning: No composer.json in current directory
```

**Solution**: The `cwd` path resolution is working correctly. This warning is harmless - it means composer is properly running in the web root.

### Cache Flush Failure

If you see:
```
⚠ Failed to flush cache: [Errno 2] No such file or directory: './maho'
```

**Solution**: Check that `maho_cli` path in config.yaml is correct and `maho` script exists in web root.

### Module Not Found (404)

If admin menu shows but clicking gives 404:

**Solution**: The most common cause is Composer's autoloader not being updated. Run:
```bash
COMPOSER_ALLOW_SUPERUSER=1 composer dump-autoload
```

Or ensure `auto_composer: true` in config.yaml.
