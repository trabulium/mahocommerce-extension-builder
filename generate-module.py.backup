#!/usr/bin/env python3
"""
Maho Module Generator

Generates a complete, working Maho module from a declarative config.
Based on proven working patterns - no guessing, just mechanical generation.

Usage:
    python generate-module.py config.json
"""

import json
import os
import sys
from pathlib import Path
from datetime import datetime

def check_conflicts(namespace, module):
    """Check if module already exists in core or vendor"""
    conflicts = []

    # Check vendor (core Maho modules)
    vendor_path = Path(f"vendor/mahocommerce/maho/app/code/core/{namespace}/{module}")
    if vendor_path.exists():
        conflicts.append(f"‚ö†Ô∏è  Module {namespace}_{module} already exists in Maho core (vendor)!")
        conflicts.append(f"   Location: {vendor_path}")

    # Check app/code/core
    core_path = Path(f"app/code/core/{namespace}/{module}")
    if core_path.exists():
        conflicts.append(f"‚ö†Ô∏è  Module {namespace}_{module} already exists in app/code/core!")
        conflicts.append(f"   Location: {core_path}")

    # Check app/code/local
    local_path = Path(f"app/code/local/{namespace}/{module}")
    if local_path.exists():
        conflicts.append(f"‚ö†Ô∏è  Module {namespace}_{module} already exists in app/code/local!")
        conflicts.append(f"   Location: {local_path}")

    # Check module declaration
    module_decl = Path(f"app/etc/modules/{namespace}_{module}.xml")
    if module_decl.exists():
        conflicts.append(f"‚ö†Ô∏è  Module declaration already exists!")
        conflicts.append(f"   Location: {module_decl}")

    return conflicts


def generate_module(config):
    """Generate a complete Maho module from config"""

    namespace = config['namespace']
    module = config['module']
    entities = config.get('entities', [])
    year = datetime.now().year

    print(f"Generating module: {namespace}_{module}")
    print(f"Entities: {', '.join([e['name'] for e in entities])}")

    # Check for conflicts
    print("\n[CHECK] Checking for conflicts...")
    conflicts = check_conflicts(namespace, module)
    if conflicts:
        print("\n‚ùå CONFLICTS DETECTED:\n")
        for conflict in conflicts:
            print(conflict)
        print("\nüí° RECOMMENDATIONS:")
        print(f"   1. Use a custom namespace (e.g., 'Custom_{module}' instead of '{namespace}_{module}')")
        print(f"   2. Choose a different module name")
        print(f"   3. Remove the existing module if you want to replace it")
        print("\nGeneration aborted to prevent conflicts.")
        sys.exit(1)
    print("  ‚úì No conflicts found")

    # Base paths - use 'local' for custom modules, 'core' for Maho/Mage namespace
    code_pool = 'local' if namespace not in ['Maho', 'Mage'] else 'core'
    code_path = Path(f"app/code/{code_pool}/{namespace}/{module}")
    etc_path = code_path / "etc"
    controllers_path = code_path / "controllers"
    blocks_path = code_path / "Block"
    models_path = code_path / "Model"
    helpers_path = code_path / "Helper"
    sql_path = code_path / "sql" / f"{namespace.lower()}_{module.lower()}_setup"

    design_path = Path(f"app/design/adminhtml/default/default")
    layout_path = design_path / "layout" / namespace.lower() / f"{module.lower()}.xml"

    module_decl_path = Path(f"app/etc/modules/{namespace}_{module}.xml")

    files_created = []

    # 1. Module Declaration
    print("\n[1] Creating module declaration...")
    module_decl_path.parent.mkdir(parents=True, exist_ok=True)
    module_decl = f"""<?xml version="1.0"?>
<!--
/**
 * Maho
 *
 * @category   {namespace}
 * @package    {namespace}_{module}
 * @copyright  Copyright (c) {year} Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/OSL-3.0 Open Software License v. 3.0 (OSL-3.0)
 */
-->
<config>
    <modules>
        <{namespace}_{module}>
            <active>true</active>
            <codePool>{code_pool}</codePool>
            <depends>
                <Mage_Core/>
                <Mage_Adminhtml/>
            </depends>
        </{namespace}_{module}>
    </modules>
</config>
"""
    module_decl_path.write_text(module_decl)
    files_created.append(str(module_decl_path))

    # 2. config.xml
    print("[2] Creating config.xml...")
    etc_path.mkdir(parents=True, exist_ok=True)

    menu_items = ""
    acl_items = ""
    model_entities = ""

    for i, entity in enumerate(entities):
        entity_name = entity['name'].lower()
        entity_title = entity.get('title', entity['name'])
        sort_order = (i + 1) * 10

        menu_items += f"""                    <{entity_name} translate="title">
                        <title>{entity_title}</title>
                        <action>adminhtml/{entity_name}/index</action>
                        <sort_order>{sort_order}</sort_order>
                    </{entity_name}>
"""

        acl_items += f"""                            <{entity_name} translate="title">
                                <title>{entity_title}</title>
                                <sort_order>{sort_order}</sort_order>
                            </{entity_name}>
"""

        model_entities += f"""                    <{entity_name}>
                        <table>{namespace.lower()}_{module.lower()}_{entity_name}</table>
                    </{entity_name}>
"""

    config_xml = f"""<?xml version="1.0"?>
<config>
    <modules>
        <{namespace}_{module}>
            <version>1.0.0</version>
        </{namespace}_{module}>
    </modules>

    <global>
        <models>
            <{namespace.lower()}_{module.lower()}>
                <class>{namespace}_{module}_Model</class>
                <resourceModel>{namespace.lower()}_{module.lower()}_resource</resourceModel>
            </{namespace.lower()}_{module.lower()}>
            <{namespace.lower()}_{module.lower()}_resource>
                <class>{namespace}_{module}_Model_Resource</class>
                <entities>
{model_entities}                </entities>
            </{namespace.lower()}_{module.lower()}_resource>
        </models>

        <resources>
            <{namespace.lower()}_{module.lower()}_setup>
                <setup>
                    <module>{namespace}_{module}</module>
                </setup>
            </{namespace.lower()}_{module.lower()}_setup>
        </resources>

        <blocks>
            <{namespace.lower()}_{module.lower()}>
                <class>{namespace}_{module}_Block</class>
            </{namespace.lower()}_{module.lower()}>
        </blocks>

        <helpers>
            <{namespace.lower()}_{module.lower()}>
                <class>{namespace}_{module}_Helper</class>
            </{namespace.lower()}_{module.lower()}>
        </helpers>
    </global>

    <admin>
        <routers>
            <adminhtml>
                <args>
                    <modules>
                        <{namespace.lower()}_{module.lower()} before="Mage_Adminhtml">{namespace}_{module}_Adminhtml</{namespace.lower()}_{module.lower()}>
                    </modules>
                </args>
            </adminhtml>
        </routers>
    </admin>

    <frontend>
        <routers>
            <{namespace.lower()}_{module.lower()}>
                <use>standard</use>
                <args>
                    <module>{namespace}_{module}</module>
                    <frontName>{config.get('frontend_route', module.lower())}</frontName>
                </args>
            </{namespace.lower()}_{module.lower()}>
        </routers>
        <layout>
            <updates>
                <{namespace.lower()}_{module.lower()}>
                    <file>{namespace.lower()}/{module.lower()}.xml</file>
                </{namespace.lower()}_{module.lower()}>
            </updates>
        </layout>
    </frontend>

    <adminhtml>
        <layout>
            <updates>
                <{namespace.lower()}_{module.lower()}>
                    <file>{namespace.lower()}/{module.lower()}.xml</file>
                </{namespace.lower()}_{module.lower()}>
            </updates>
        </layout>

        <menu>
            <{namespace.lower()}_{module.lower()} translate="title">
                <title>{config.get('menu_title', module)}</title>
                <sort_order>{config.get('menu_sort', 80)}</sort_order>
                <children>
{menu_items}                </children>
            </{namespace.lower()}_{module.lower()}>
        </menu>
    </adminhtml>
</config>
"""
    (etc_path / "config.xml").write_text(config_xml)
    files_created.append(str(etc_path / "config.xml"))

    # 3. adminhtml.xml (ACL)
    print("[3] Creating adminhtml.xml...")
    adminhtml_xml = f"""<?xml version="1.0"?>
<config>
    <acl>
        <resources>
            <admin>
                <children>
                    <{namespace.lower()}_{module.lower()} translate="title">
                        <title>{config.get('menu_title', module)}</title>
                        <sort_order>{config.get('menu_sort', 80)}</sort_order>
                        <children>
{acl_items}                        </children>
                    </{namespace.lower()}_{module.lower()}>
                </children>
            </admin>
        </resources>
    </acl>
</config>
"""
    (etc_path / "adminhtml.xml").write_text(adminhtml_xml)
    files_created.append(str(etc_path / "adminhtml.xml"))

    # 4. Helper
    print("[4] Creating helper...")
    helpers_path.mkdir(parents=True, exist_ok=True)
    helper_data = f"""<?php
/**
 * Maho
 *
 * @category   {namespace}
 * @package    {namespace}_{module}
 * @copyright  Copyright (c) {year} Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/OSL-3.0 Open Software License v. 3.0 (OSL-3.0)
 */

/**
 * {module} Data Helper
 */
class {namespace}_{module}_Helper_Data extends Mage_Core_Helper_Abstract
{{
}}
"""
    (helpers_path / "Data.php").write_text(helper_data)
    files_created.append(str(helpers_path / "Data.php"))

    # 5. Generate files for each entity
    print(f"\n[5] Generating {len(entities)} entities...")

    layout_handles = ""

    for entity in entities:
        entity_name = entity['name']
        entity_lower = entity_name.lower()
        entity_title = entity.get('title', entity_name)
        entity_class = entity_name.capitalize()
        fields = entity.get('fields', [])

        print(f"  - {entity_name}")

        # Generate entity files
        files_created.extend(generate_entity_files(
            namespace, module, entity_name, entity_class, entity_title,
            fields, code_path, year
        ))

        # Add layout handles
        layout_handles += generate_layout_handles(
            namespace.lower(), module.lower(), entity_lower
        )

    # 6. Layout XML
    print("\n[6] Creating layout XML...")
    layout_path.parent.mkdir(parents=True, exist_ok=True)
    layout_xml = f"""<?xml version="1.0"?>
<layout>
{layout_handles}</layout>
"""
    layout_path.write_text(layout_xml)
    files_created.append(str(layout_path))

    # 7. Database setup script
    if entities:
        print("\n[7] Creating database setup script...")
        sql_path.mkdir(parents=True, exist_ok=True)
        setup_script = generate_setup_script(namespace, module, entities, year)
        setup_file = sql_path / "install-1.0.0.php"
        setup_file.write_text(setup_script)
        files_created.append(str(setup_file))

    print(f"\n‚úÖ Module generated successfully!")
    print(f"   Created {len(files_created)} files")
    print(f"\nNext steps:")
    print(f"  1. composer dump-autoload")
    print(f"  2. ./maho cache:flush")
    print(f"  3. Access admin menu: {config.get('menu_title', module)}")

    return files_created


def generate_entity_files(namespace, module, entity_name, entity_class, entity_title, fields, code_path, year):
    """Generate all files for a single entity"""
    files = []
    entity_lower = entity_name.lower()
    id_field = f"{entity_lower}_id"

    # Model
    model_path = code_path / "Model"
    model_path.mkdir(parents=True, exist_ok=True)

    model_class = f""" <?php
/**
 * Maho
 */
class {namespace}_{module}_Model_{entity_class} extends Mage_Core_Model_Abstract
{{
    public const STATUS_ENABLED = 1;
    public const STATUS_DISABLED = 0;

    protected function _construct()
    {{
        $this->_init('{namespace.lower()}_{module.lower()}/{entity_lower}');
    }}

    public static function getAvailableStatuses(): array
    {{
        return [
            self::STATUS_ENABLED => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Enabled'),
            self::STATUS_DISABLED => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Disabled'),
        ];
    }}
}}
"""
    (model_path / f"{entity_class}.php").write_text(model_class)
    files.append(str(model_path / f"{entity_class}.php"))

    # Resource Model
    resource_path = model_path / "Resource"
    resource_path.mkdir(parents=True, exist_ok=True)

    resource_class = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Model_Resource_{entity_class} extends Mage_Core_Model_Resource_Db_Abstract
{{
    protected function _construct()
    {{
        $this->_init('{namespace.lower()}_{module.lower()}/{entity_lower}', '{id_field}');
    }}
}}
"""
    (resource_path / f"{entity_class}.php").write_text(resource_class)
    files.append(str(resource_path / f"{entity_class}.php"))

    # Collection
    collection_path = resource_path / f"{entity_class}"
    collection_path.mkdir(parents=True, exist_ok=True)

    collection_class = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Model_Resource_{entity_class}_Collection extends Mage_Core_Model_Resource_Db_Collection_Abstract
{{
    protected function _construct()
    {{
        $this->_init('{namespace.lower()}_{module.lower()}/{entity_lower}');
    }}
}}
"""
    (collection_path / "Collection.php").write_text(collection_class)
    files.append(str(collection_path / "Collection.php"))

    # Controller
    controller_path = code_path / "controllers" / "Adminhtml"
    controller_path.mkdir(parents=True, exist_ok=True)

    controller_class = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Adminhtml_{entity_class}Controller extends Mage_Adminhtml_Controller_Action
{{
    protected function _init{entity_class}()
    {{
        ${entity_lower}Id = (int) $this->getRequest()->getParam('id');
        ${entity_lower} = Mage::getModel('{namespace.lower()}_{module.lower()}/{entity_lower}');
        if (${entity_lower}Id) {{
            ${entity_lower}->load(${entity_lower}Id);
        }}
        Mage::register('current_{entity_lower}', ${entity_lower});
        return ${entity_lower};
    }}

    public function indexAction()
    {{
        $this->_title($this->__('{module}'))
             ->_title($this->__('{entity_title}'));

        $this->loadLayout();
        $this->renderLayout();
    }}

    public function gridAction()
    {{
        $this->loadLayout();
        $this->renderLayout();
    }}

    public function newAction()
    {{
        $this->_forward('edit');
    }}

    public function editAction()
    {{
        ${entity_lower}Id = $this->getRequest()->getParam('id');
        ${entity_lower} = $this->_init{entity_class}();

        if (${entity_lower}Id && !${entity_lower}->getId()) {{
            $this->_getSession()->addError(Mage::helper('{namespace.lower()}_{module.lower()}')->__('This {entity_lower} no longer exists.'));
            $this->_redirect('*/*/');
            return;
        }}

        $data = Mage::getSingleton('adminhtml/session')->getFormData(true);
        if (!empty($data)) {{
            ${entity_lower}->setData($data);
        }}

        Mage::register('{entity_lower}_data', ${entity_lower});

        $this->loadLayout();
        $this->_title(Mage::helper('{namespace.lower()}_{module.lower()}')->__('{entity_title}'));
        if (${entity_lower}->getId()) {{
            $this->_title(${entity_lower}->getId());
        }} else {{
            $this->_title(Mage::helper('{namespace.lower()}_{module.lower()}')->__('Add {entity_class}'));
        }}

        $this->renderLayout();
    }}

    public function saveAction()
    {{
        if ($data = $this->getRequest()->getPost()) {{
            try {{
                ${entity_lower} = $this->_init{entity_class}();
                ${entity_lower}->addData($data);
                ${entity_lower}->save();

                Mage::getSingleton('adminhtml/session')->addSuccess(
                    Mage::helper('{namespace.lower()}_{module.lower()}')->__('{entity_class} was successfully saved')
                );
                Mage::getSingleton('adminhtml/session')->setFormData(false);

                if ($this->getRequest()->getParam('back')) {{
                    $this->_redirect('*/*/edit', array('id' => ${entity_lower}->getId()));
                    return;
                }}
                $this->_redirect('*/*/');
                return;
            }} catch (Mage_Core_Exception $e) {{
                Mage::getSingleton('adminhtml/session')->addError($e->getMessage());
                Mage::getSingleton('adminhtml/session')->setFormData($data);
                $this->_redirect('*/*/edit', array('id' => $this->getRequest()->getParam('id')));
                return;
            }} catch (Exception $e) {{
                Mage::logException($e);
                Mage::getSingleton('adminhtml/session')->addError(
                    Mage::helper('{namespace.lower()}_{module.lower()}')->__('There was a problem saving the {entity_lower}.')
                );
                Mage::getSingleton('adminhtml/session')->setFormData($data);
                $this->_redirect('*/*/edit', array('id' => $this->getRequest()->getParam('id')));
                return;
            }}
        }}
        Mage::getSingleton('adminhtml/session')->addError(
            Mage::helper('{namespace.lower()}_{module.lower()}')->__('Unable to find {entity_lower} to save.')
        );
        $this->_redirect('*/*/');
    }}

    public function deleteAction()
    {{
        if ($this->getRequest()->getParam('id') > 0) {{
            try {{
                ${entity_lower} = Mage::getModel('{namespace.lower()}_{module.lower()}/{entity_lower}');
                ${entity_lower}->setId($this->getRequest()->getParam('id'))->delete();

                Mage::getSingleton('adminhtml/session')->addSuccess(
                    Mage::helper('{namespace.lower()}_{module.lower()}')->__('{entity_class} was successfully deleted.')
                );
                $this->_redirect('*/*/');
                return;
            }} catch (Mage_Core_Exception $e) {{
                Mage::getSingleton('adminhtml/session')->addError($e->getMessage());
                $this->_redirect('*/*/edit', array('id' => $this->getRequest()->getParam('id')));
            }} catch (Exception $e) {{
                Mage::getSingleton('adminhtml/session')->addError(
                    Mage::helper('{namespace.lower()}_{module.lower()}')->__('There was an error deleting {entity_lower}.')
                );
                $this->_redirect('*/*/edit', array('id' => $this->getRequest()->getParam('id')));
                Mage::logException($e);
                return;
            }}
        }}
        Mage::getSingleton('adminhtml/session')->addError(
            Mage::helper('{namespace.lower()}_{module.lower()}')->__('Could not find {entity_lower} to delete.')
        );
        $this->_redirect('*/*/');
    }}

    public function massDeleteAction()
    {{
        ${entity_lower}Ids = $this->getRequest()->getParam('{entity_lower}');
        if (!is_array(${entity_lower}Ids)) {{
            Mage::getSingleton('adminhtml/session')->addError(
                Mage::helper('{namespace.lower()}_{module.lower()}')->__('Please select {entity_lower}(s) to delete.')
            );
        }} else {{
            try {{
                foreach (${entity_lower}Ids as ${entity_lower}Id) {{
                    ${entity_lower} = Mage::getModel('{namespace.lower()}_{module.lower()}/{entity_lower}');
                    ${entity_lower}->setId(${entity_lower}Id)->delete();
                }}
                Mage::getSingleton('adminhtml/session')->addSuccess(
                    Mage::helper('{namespace.lower()}_{module.lower()}')->__(
                        'Total of %d {entity_lower}(s) were successfully deleted.',
                        count(${entity_lower}Ids)
                    )
                );
            }} catch (Mage_Core_Exception $e) {{
                Mage::getSingleton('adminhtml/session')->addError($e->getMessage());
            }} catch (Exception $e) {{
                Mage::getSingleton('adminhtml/session')->addError(
                    Mage::helper('{namespace.lower()}_{module.lower()}')->__('There was an error deleting {entity_lower}(s).')
                );
                Mage::logException($e);
            }}
        }}
        $this->_redirect('*/*/index');
    }}

    protected function _isAllowed()
    {{
        return Mage::getSingleton('admin/session')->isAllowed('{namespace.lower()}_{module.lower()}/{entity_lower}');
    }}
}}
"""
    (controller_path / f"{entity_class}Controller.php").write_text(controller_class)
    files.append(str(controller_path / f"{entity_class}Controller.php"))

    # Blocks
    blocks_path = code_path / "Block" / "Adminhtml"
    blocks_path.mkdir(parents=True, exist_ok=True)

    # Grid Container
    grid_container = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Block_Adminhtml_{entity_class} extends Mage_Adminhtml_Block_Widget_Grid_Container
{{
    public function __construct()
    {{
        $this->_blockGroup = '{namespace.lower()}_{module.lower()}';
        $this->_controller = 'adminhtml_{entity_lower}';
        $this->_headerText = Mage::helper('{namespace.lower()}_{module.lower()}')->__('{entity_title}');
        $this->_addButtonLabel = Mage::helper('{namespace.lower()}_{module.lower()}')->__('Add New');
        parent::__construct();
    }}
}}
"""
    (blocks_path / f"{entity_class}.php").write_text(grid_container)
    files.append(str(blocks_path / f"{entity_class}.php"))

    # Grid
    entity_block_path = blocks_path / entity_class
    entity_block_path.mkdir(parents=True, exist_ok=True)

    grid_columns = f"""        $this->addColumn('{id_field}', [
            'header' => Mage::helper('{namespace.lower()}_{module.lower()}')->__('ID'),
            'align'  => 'right',
            'width'  => '50px',
            'index'  => '{id_field}',
            'type'   => 'number',
        ]);

        $this->addColumn('name', [
            'header' => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Name'),
            'align'  => 'left',
            'index'  => 'name',
        ]);

        $this->addColumn('status', [
            'header'  => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Status'),
            'align'   => 'left',
            'width'   => '80px',
            'index'   => 'status',
            'type'    => 'options',
            'options' => {namespace}_{module}_Model_{entity_class}::getAvailableStatuses(),
        ]);
"""

    grid_class = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Block_Adminhtml_{entity_class}_Grid extends Mage_Adminhtml_Block_Widget_Grid
{{
    public function __construct()
    {{
        parent::__construct();
        $this->setId('{entity_lower}Grid');
        $this->setDefaultSort('created_at');
        $this->setDefaultDir('DESC');
        $this->setSaveParametersInSession(true);
        $this->setUseAjax(true);
    }}

    protected function _prepareCollection()
    {{
        $collection = Mage::getModel('{namespace.lower()}_{module.lower()}/{entity_lower}')->getCollection();
        $this->setCollection($collection);
        return parent::_prepareCollection();
    }}

    protected function _prepareColumns()
    {{
{grid_columns}
        return parent::_prepareColumns();
    }}

    protected function _prepareMassaction()
    {{
        $this->setMassactionIdField('{id_field}');
        $this->getMassactionBlock()->setFormFieldName('{entity_lower}');

        $this->getMassactionBlock()->addItem('delete', array(
            'label'   => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Delete'),
            'url'     => $this->getUrl('*/*/massDelete'),
            'confirm' => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Are you sure?')
        ));

        return $this;
    }}

    public function getGridUrl()
    {{
        return $this->getUrl('*/*/grid', ['_current' => true]);
    }}

    public function getRowUrl($row)
    {{
        return $this->getUrl('*/*/edit', array('id' => $row->getId()));
    }}
}}
"""
    (entity_block_path / "Grid.php").write_text(grid_class)
    files.append(str(entity_block_path / "Grid.php"))

    # Edit Block (Form Container)
    edit_block = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Block_Adminhtml_{entity_class}_Edit extends Mage_Adminhtml_Block_Widget_Form_Container
{{
    public function __construct()
    {{
        parent::__construct();
        $this->_blockGroup = '{namespace.lower()}_{module.lower()}';
        $this->_controller = 'adminhtml_{entity_lower}';

        $this->_updateButton('save', 'label', Mage::helper('{namespace.lower()}_{module.lower()}')->__('Save {entity_class}'));
        $this->_updateButton('delete', 'label', Mage::helper('{namespace.lower()}_{module.lower()}')->__('Delete {entity_class}'));
        $this->_addButton('saveandcontinue', array(
            'label'   => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Save And Continue Edit'),
            'onclick' => 'saveAndContinueEdit()',
            'class'   => 'save',
        ), -100);

        $this->_formScripts[] = "
            function saveAndContinueEdit() {{
                editForm.submit($('edit_form').action+'back/edit/');
            }}
        ";
    }}

    public function getHeaderText()
    {{
        if (Mage::registry('{entity_lower}_data') && Mage::registry('{entity_lower}_data')->getId()) {{
            return Mage::helper('{namespace.lower()}_{module.lower()}')->__(
                'Edit {entity_class} #%s',
                Mage::registry('{entity_lower}_data')->getId()
            );
        }} else {{
            return Mage::helper('{namespace.lower()}_{module.lower()}')->__('Add {entity_class}');
        }}
    }}
}}
"""
    (entity_block_path / "Edit.php").write_text(edit_block)
    files.append(str(entity_block_path / "Edit.php"))

    # Edit/Form Block
    edit_form_path = entity_block_path / "Edit"
    edit_form_path.mkdir(parents=True, exist_ok=True)

    edit_form = f"""<?php
/**
 * Maho
 */
class {namespace}_{module}_Block_Adminhtml_{entity_class}_Edit_Form extends Mage_Adminhtml_Block_Widget_Form
{{
    protected function _prepareForm()
    {{
        $form = new Varien_Data_Form(array(
            'id'      => 'edit_form',
            'action'  => $this->getUrl('*/*/save', array('id' => $this->getRequest()->getParam('id'))),
            'method'  => 'post',
            'enctype' => 'multipart/form-data'
        ));
        $form->setUseContainer(true);
        $this->setForm($form);

        ${entity_lower} = Mage::registry('{entity_lower}_data');

        $fieldset = $form->addFieldset('base_fieldset', array(
            'legend' => Mage::helper('{namespace.lower()}_{module.lower()}')->__('{entity_class} Information'),
            'class'  => 'fieldset-wide',
        ));

        if (${entity_lower} && ${entity_lower}->getId()) {{
            $fieldset->addField('{id_field}', 'hidden', array(
                'name' => '{id_field}',
            ));
        }}

        $fieldset->addField('name', 'text', array(
            'label'    => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Name'),
            'name'     => 'name',
            'required' => true,
        ));

        $fieldset->addField('status', 'select', array(
            'label'   => Mage::helper('{namespace.lower()}_{module.lower()}')->__('Status'),
            'name'    => 'status',
            'values'  => {namespace}_{module}_Model_{entity_class}::getAvailableStatuses(),
        ));

        if (${entity_lower}) {{
            $form->setValues(${entity_lower}->getData());
        }}

        return parent::_prepareForm();
    }}
}}
"""
    (edit_form_path / "Form.php").write_text(edit_form)
    files.append(str(edit_form_path / "Form.php"))

    return files


def generate_layout_handles(namespace, module, entity):
    """Generate layout XML handles for an entity"""
    return f"""    <adminhtml_{entity}_index>
        <reference name="content">
            <block type="{namespace}_{module}/adminhtml_{entity}" name="{module}_{entity}" />
        </reference>
    </adminhtml_{entity}_index>

    <adminhtml_{entity}_grid>
        <block type="{namespace}_{module}/adminhtml_{entity}_grid" name="root" output="toHtml" />
    </adminhtml_{entity}_grid>

    <adminhtml_{entity}_edit>
        <reference name="content">
            <block type="{namespace}_{module}/adminhtml_{entity}_edit" name="{entity}.edit" />
        </reference>
        <reference name="left">
            <block type="adminhtml/store_switcher" name="store_switcher" before="-">
                <action method="setUseConfirm"><params>1</params></action>
            </block>
        </reference>
    </adminhtml_{entity}_edit>

"""


def generate_setup_script(namespace, module, entities, year):
    """Generate database setup script"""
    tables = ""

    for entity in entities:
        entity_lower = entity['name'].lower()
        table_name = f"{namespace.lower()}_{module.lower()}_{entity_lower}"
        id_field = f"{entity_lower}_id"
        fields = entity.get('fields', [])

        columns = f"""    ->addColumn('{id_field}', Varien_Db_Ddl_Table::TYPE_INTEGER, null, [
        'identity'  => true,
        'nullable'  => false,
        'primary'   => true,
    ], 'ID')
    ->addColumn('name', Varien_Db_Ddl_Table::TYPE_VARCHAR, 255, [
        'nullable'  => false,
    ], 'Name')
    ->addColumn('status', Varien_Db_Ddl_Table::TYPE_SMALLINT, null, [
        'nullable'  => false,
        'default'   => '1',
    ], 'Status')
    ->addColumn('created_at', Varien_Db_Ddl_Table::TYPE_TIMESTAMP, null, [
        'nullable'  => false,
        'default'   => Varien_Db_Ddl_Table::TIMESTAMP_INIT,
    ], 'Created At')
    ->addColumn('updated_at', Varien_Db_Ddl_Table::TYPE_TIMESTAMP, null, [
        'nullable'  => false,
        'default'   => Varien_Db_Ddl_Table::TIMESTAMP_INIT_UPDATE,
    ], 'Updated At')"""

        tables += f"""
$table = $installer->getConnection()
    ->newTable($installer->getTable('{namespace.lower()}_{module.lower()}/{entity_lower}'))
{columns}
    ->setComment('{entity['name']} Table');

$installer->getConnection()->createTable($table);

"""

    return f"""<?php
/**
 * Maho
 *
 * @copyright  Copyright (c) {year} Maho (https://mahocommerce.com)
 * @license    https://opensource.org/licenses/OSL-3.0 Open Software License v. 3.0 (OSL-3.0)
 */

$installer = $this;
$installer->startSetup();

{tables}
$installer->endSetup();
"""


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python generate-module.py config.json")
        sys.exit(1)

    config_file = sys.argv[1]

    if not os.path.exists(config_file):
        print(f"Error: Config file not found: {config_file}")
        sys.exit(1)

    with open(config_file) as f:
        config = json.load(f)

    try:
        generate_module(config)
        print("\n‚úÖ SUCCESS - Module generated and ready to use!")
    except Exception as e:
        print(f"\n‚ùå ERROR: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
